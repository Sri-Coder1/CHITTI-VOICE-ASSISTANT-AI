<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CHITTI v2.1 â€” Voice AI</title>

  <link rel="shortcut icon" href="assets/img/sophia.ico">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="space-container">

  <!-- STAR BACKGROUND -->
  <div class="stars"></div>
  <div class="stars2"></div>
  <div class="stars3"></div>

  <!-- CORE -->
  <div class="chitti-container">

    <!-- CHAT STATUS -->
    <div id="chat-status" class="chat-status"></div>

    <!-- RINGS -->
    <div class="rings-wrapper">
      <div class="ring ring-1"></div>
      <div class="ring ring-2"></div>
      <div class="ring ring-3"></div>
      <div class="ring ring-4"></div>
      <div class="ring ring-5"></div>
    </div>

    <!-- CORE LOGO -->
    <div class="chitti-core">
      <span class="logo-text">CHITTI</span>
    </div>
  </div>

  <!-- INPUT CONSOLE -->
  <div class="glass-panel">
    <input id="chatbox" type="text" placeholder="Ask me anything..." autocomplete="off"/>
    <button id="MicBtn" class="icon-btn">
      <i class="bi bi-mic"></i>
    </button>
    <button id="ChatBtn" class="icon-btn">
      <i class="bi bi-send"></i>
    </button>
  </div>
</div>

<!-- DEPENDENCIES -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="/eel.js"></script>

<!-- ================= MAIN LOGIC ================= -->
<script>
  let isSpeaking = false;

  /* -------- TEXT INPUT -------- */
  function processPrompt() {
    const input = document.getElementById("chatbox");
    const query = input.value.trim();
    if (!query) return;

    eel.handleDynamicQuery(query);
    input.value = "";
  }

  document.getElementById("ChatBtn").onclick = processPrompt;
  document.getElementById("chatbox").addEventListener("keypress", e => {
    if (e.key === "Enter") processPrompt();
  });

  /* -------- MIC / STOP BUTTON -------- */
  document.getElementById("MicBtn").addEventListener("click", () => {
    if (isSpeaking) {
      eel.stopSpeaking();        // ðŸ›‘ stop speech
    } else {
      eel.toggle_listening();   // ðŸŽ™ start listening
    }
  });

  /* -------- BACKEND â†’ UI SPEAK STATE -------- */
  eel.expose(setSpeakingState);
  function setSpeakingState(state) {
    isSpeaking = state;

    const btn = document.getElementById("MicBtn");
    const rings = document.querySelector(".rings-wrapper");

    if (state) {
      btn.innerHTML = '<i class="bi bi-stop-fill"></i>';
      btn.style.color = "#ff3366";
      rings.classList.add("faded");
    } else {
      btn.innerHTML = '<i class="bi bi-mic"></i>';
      btn.style.color = "#00eaff";
      rings.classList.remove("faded");
    }
  }

  /* -------- STATUS CHAT BUBBLES -------- */
  eel.expose(DisplayMessage);
  function DisplayMessage(message) {
    const container = document.getElementById("chat-status");

    const bubble = document.createElement("div");
    bubble.className = "status-bubble";

    if (message.toLowerCase().startsWith("you said")) {
      bubble.classList.add("user");
    }

    bubble.innerText = message;
    container.appendChild(bubble);

    while (container.children.length > 4) {
      container.removeChild(container.firstChild);
    }
  }
</script>
<script>
  eel.expose(DisplayAssistantMessage);

  function DisplayAssistantMessage(text) {
    const container = document.getElementById("chat-status");

    const bubble = document.createElement("div");
    bubble.className = "status-bubble assistant";

    bubble.innerText = text;
    container.appendChild(bubble);

    // keep only last 5 messages
    while (container.children.length > 5) {
      container.removeChild(container.firstChild);
    }
  }
</script>
<script>
  function forceCloseWindow() {
    window.close();
  }
  eel.expose(forceCloseWindow);
</script>

</html>
